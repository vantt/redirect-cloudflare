<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>9</storyId>
    <title>Debug Parameter Rename and Parsing Enhancements</title>
    <status>Draft</status>
    <generatedAt>2025-10-27</generatedAt>
    <generator>Manual Story Context Assembly</generator>
    <sourceStoryPath>docs/stories/story-1.9.md</sourceStoryPath>
    <deprecationNotice>
      This context documents the transition from legacy `n=` parameter to `debug=` parameter.
      Story 1.9 introduced `debug=` as replacement for `n=`.
      Story 1.10 completed the migration by REMOVING all `n=` parameter support.
      See docs/changes/legacy-n-param-removal-2025-10-28.md for details.
    </deprecationNotice>
  </metadata>

  <story>
    <asA>developer-support lead</asA>
    <iWant>the redirect workflow to expose an explicit `debug` query parameter instead of `n`, handling it consistently in both outer requests and embedded destinations</iWant>
    <soThat>debug scenarios remain understandable and reliable even when links are generated externally</soThat>
    <tasks>
      <task id="T1" ac="1">Rename query parameter usage from `n` to `debug` across route handler, schema, and helpers (log legacy usage).</task>
      <task id="T2" ac="2">Enhance parsing utilities to detect `debug` in both outer query and destination payload while avoiding duplication.</task>
      <task id="T3" ac="3">Update and extend unit/integration tests covering new parameter name, raw `to` interplay, and legacy fallback.</task>
      <task id="T4" ac="4">Sweep documentation (PRD, architecture, README, contexts/tests) to reference `debug` consistently.</task>
      <task id="T5" ac="5">Document rollout guidance including logging/deprecation messaging for legacy parameter usage.</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Update `/r` route and utilities to accept `debug` instead of `n`, including zod schema and debug payload logic; optionally log legacy `n` use.</criterion>
    <criterion id="2">Ensure parsing recognizes `debug` in both the primary request and inside the destination URL (raw or encoded) without leaking into the redirect response.</criterion>
    <criterion id="3">Refresh unit/integration tests to cover renamed parameter scenarios, raw `to` combinations, and legacy fallback behavior.</criterion>
    <criterion id="4">Update documentation (PRD, architecture, README, contexts, tests) to reference `debug` instead of `n`.</criterion>
    <criterion id="5">Document rollout/monitoring guidance showing how `debug` appears in logs and tooling.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.9: Debug Parameter Rename and Parsing Enhancements</section>
        <snippet>Defines acceptance criteria for renaming the debug parameter, updating parsing, tests, and documentation sweep.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>PRD</title>
        <section>Section 5.9 Debugging & Query Handling</section>
        <snippet>Describes debug mode behavior (`debug=1`) returning JSON payloads; guides how isNoRedirect maps to the debug flag.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Redirect Engine Debug Flow</section>
        <snippet>Documents debug mode response format and curl example now referencing `debug=1`, informing implementation and tests.</snippet>
      </doc>
      <doc>
        <path>README.md</path>
        <title>Developer README</title>
        <section>Redirect Usage â€“ Debug Mode</section>
        <snippet>Provides usage instructions showing `debug=1` requests, legacy compatibility note, and error response expectations.</snippet>
      </doc>
      <doc>
        <path>docs/stories/story-context-1.8.xml</path>
        <title>Story Context 1.8</title>
        <section>Constraints & Tests</section>
        <snippet>Highlights raw `to` parsing rules which must remain compatible when introducing `debug` handling.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>src/routes/redirect.ts</path>
        <kind>route</kind>
        <symbol>app.get('/', ...)</symbol>
        <lines>1-140</lines>
        <reason>Main redirect handler requiring query rename, new parsing utility invocation, and legacy logging.</reason>
      </artifact>
      <artifact>
        <path>src/lib/validation.ts</path>
        <kind>validation</kind>
        <symbol>redirectSchema</symbol>
        <lines>1-60</lines>
        <reason>Zod schema enforcing query parameters; must evolve to accept `debug` while deprecating `n` safely.</reason>
      </artifact>
      <artifact>
        <path>src/lib/errors.ts</path>
        <kind>error-class</kind>
        <symbol>RedirectError</symbol>
        <lines>1-60</lines>
        <reason>Error codes/messages for malformed parameters; may add new codes for legacy usage or conflicting flags.</reason>
      </artifact>
      <artifact>
        <path>test/integration/redirect-endpoint.test.ts</path>
        <kind>integration-test</kind>
        <symbol>describe('redirect endpoint')</symbol>
        <lines>1-220</lines>
        <reason>Integration coverage verifying debug behavior, raw `to` interactions, and error paths; requires updates.</reason>
      </artifact>
      <artifact>
        <path>test/unit/lib/redirect-logic.test.ts</path>
        <kind>unit-test</kind>
        <symbol>describe('getRedirectQuery')</symbol>
        <lines>1-180</lines>
        <reason>Unit tests for parsing logic; central place to validate new extraction helper and legacy compatibility.</reason>
      </artifact>
    </code>

    <dependencies>
      <typescript>5.9.0</typescript>
      <hono>4.4.0</hono>
      <zod>4.1.0</zod>
      <vitest>4.0.3</vitest>
      <miniflare>3.20250718.2</miniflare>
      <wrangler>4.45.3</wrangler>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Maintain compatibility with raw `to` parsing rules introduced in Story 1.8.</constraint>
    <constraint>Provide graceful handling/logging for legacy `n` usage during migration (avoid breaking analytics).</constraint>
    <constraint>Ensure only HTTP/HTTPS destinations remain valid after parameter rename.</constraint>
    <constraint>Keep Workers-compatible implementation; avoid Node-specific APIs while parsing query strings.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>parseDebugFlag</name>
      <kind>Function (new)</kind>
      <signature>function parseDebugFlag(rawQuery: string, destination: string): { debug: boolean; warnings: string[] }</signature>
      <path>src/routes/redirect.ts</path>
    </interface>
    <interface>
      <name>redirectSchema</name>
      <kind>Zod Schema</kind>
      <signature>const redirectSchema: z.ZodObject&lt;{ to: string; debug?: string; legacyN?: string }&gt;</signature>
      <path>src/lib/validation.ts</path>
    </interface>
    <interface>
      <name>createDebugResponse</name>
      <kind>Function</kind>
      <signature>function createDebugResponse(destination: string, debugInfo?: Record&lt;string, unknown&gt;): Response</signature>
      <path>src/routes/redirect.ts</path>
    </interface>
    <interface>
      <name>extractTrackingParams</name>
      <kind>Function</kind>
      <signature>function extractTrackingParams(url: string): TrackingParams</signature>
      <path>src/lib/tracking.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Follow Vitest + Miniflare guidelines; ensure fixtures from Story 1.7 support new debug scenarios.</standards>
    <locations>
      <location>test/unit/lib/redirect-logic.test.ts</location>
      <location>test/integration/redirect-endpoint.test.ts</location>
      <location>test/integration/redirect-debug.test.ts</location>
      <location>test/fixtures/env.test.ts</location>
    </locations>
    <ideas>
      <idea ac="1,3">Unit test verifying `debug=1` at top-level triggers debug mode while logging legacy `n=1` usage.</idea>
      <idea ac="2,3">Integration test ensuring `to=https://example.com?debug=1` still activates debug without double redirect.</idea>
      <idea ac="2">Test case for raw `to` with embedded `debug=1` encoded/unencoded to ensure parser handles both.</idea>
      <idea ac="3">Regression test confirming legacy `n=1` still returns debug payload but warns in logs.</idea>
      <idea ac="5">Test verifying debug response metadata/logging includes clear messaging about the new parameter.</idea>
    </ideas>
  </tests>
</story-context>
