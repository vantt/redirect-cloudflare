<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>8</storyId>
    <title>Raw `to` Query Support</title>
    <status>Draft</status>
    <generatedAt>2025-10-27</generatedAt>
    <generator>Manual assembly (workflow unavailable)</generator>
    <sourceStoryPath>docs/stories/story-1.8.md</sourceStoryPath>
    <deprecationNotice>
      This context was written when the API used legacy `n=` parameter for debug mode.
      BREAKING CHANGE in Story 1.10: The `n=` parameter has been REMOVED.
      All references to `n` parameter below now refer to the `debug` parameter.
      See docs/changes/legacy-n-param-removal-2025-10-28.md for details.
    </deprecationNotice>
  </metadata>

  <story>
    <asA>campaign manager</asA>
    <iWant>the redirect endpoint to accept a raw `to` query parameter without pre-encoding</iWant>
    <soThat>short links generated by tools that append the destination URL verbatim still redirect correctly</soThat>
    <tasks>
      <task id="T1" ac="1">Refactor redirect query parsing to locate the final `to=` segment and verify `n` ordering.</task>
      <task id="T2" ac="2">Implement destination parsing/decode utility that handles raw versus encoded inputs with single-decode safety.</task>
      <task id="T3" ac="3">Add error handling branches returning 400 with specific error codes for missing/invalid parameters.</task>
      <task id="T4" ac="4">Author unit and integration tests for raw, encoded, and failure scenarios, validating status/headers/logging.</task>
      <task id="T5" ac="5">Update README or developer docs to describe raw `to` support and encoding guidance.</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Update the `/r` handler to derive the destination by locating the final `to=` segment in the original query string (after confirming `n` is present before it) instead of using `URLSearchParams.get('to').</criterion>
    <criterion id="2">When parsing the destination: if the substring after `to=` is valid URL-encoded data then decode it exactly once; otherwise accept the raw substring unchanged. Preserve existing validation (protocol, allowlist, redirect-type lookup).</criterion>
    <criterion id="3">Return a 400 response with descriptive error codes when `n` is missing, when `to` is missing or not the last parameter, or when decoding fails (e.g., malformed percent-encoding).</criterion>
    <criterion id="4">Extend unit and integration tests to cover: Raw `to` containing additional query parameters. Properly URL-encoded `to` values. Error paths for missing `n`, missing `to`, and malformed encodings. Tests must verify redirect status, headers, and logged metadata.</criterion>
    <criterion id="5">Update developer documentation (README redirect usage or equivalent) to explain the new raw `to` support, including guidance that URL-encoding remains recommended for complex destinations.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.8: Raw `to` Query Support</section>
        <snippet>Acceptance Criteria specify string extraction for the final `to=` parameter, single-decode logic, error handling, expanded tests, and documentation updates.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>PRD</title>
        <section>2.2 Non-Functional Requirements (NFR5)</section>
        <snippet>Reliability requires tracking and redirect logic to succeed without losing data; parsing changes must not compromise pre-redirect behavior.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Redirect Engine Components</section>
        <snippet>Defines `/r` endpoint responsibilities, validation patterns, and reliance on Cloudflare Workers + Hono routing.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Testing</section>
        <snippet>Vitest + Miniflare stack mandated for unit/integration coverage; new scenarios must align with this workflow.</snippet>
      </doc>
      <doc>
        <path>README.md</path>
        <title>Project README</title>
        <section>Configuration / Redirect Usage</section>
        <snippet>Existing guidance on building redirect URLs must expand to mention raw `to` handling and best practices.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>src/routes/redirect.ts</path>
        <kind>route</kind>
        <symbol>app.get('/', ...)</symbol>
        <lines>1-120</lines>
        <reason>Primary redirect handler performing query parsing, validation, KV lookups, and response creation.</reason>
      </artifact>
      <artifact>
        <path>src/lib/validation.ts</path>
        <kind>validation</kind>
        <symbol>redirectSchema</symbol>
        <lines>1-50</lines>
        <reason>Schema enforces HTTP/HTTPS and `n` expectations; may need adjustments or additional validation helpers.</reason>
      </artifact>
      <artifact>
        <path>src/lib/errors.ts</path>
        <kind>error-class</kind>
        <symbol>RedirectError</symbol>
        <lines>1-60</lines>
        <reason>Standardized error responses; new 400 error cases should use this class.</reason>
      </artifact>
      <artifact>
        <path>test/integration/redirect-endpoint.test.ts</path>
        <kind>integration-test</kind>
        <symbol>describe('redirect endpoint')</symbol>
        <lines>1-200</lines>
        <reason>Integration coverage for redirect behavior; extend with raw/encoded scenarios.</reason>
      </artifact>
      <artifact>
        <path>test/unit/lib/redirect-logic.test.ts</path>
        <kind>unit-test</kind>
        <symbol>describe('getRedirectQuery')</symbol>
        <lines>1-150</lines>
        <reason>Unit tests for query parsing currently rely on `URLSearchParams`; refactor to new logic.</reason>
      </artifact>
    </code>

    <dependencies>
      <typescript>5.9.0</typescript>
      <hono>4.4.0</hono>
      <zod>4.1.0</zod>
      <vitest>4.0.3</vitest>
      <miniflare>3.20250718.2</miniflare>
      <wrangler>4.45.3</wrangler>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Maintain HTTP/HTTPS enforcement and allowlist checks when introducing custom parsing.</constraint>
    <constraint>Ensure parsing changes remain Workers-compatible (no Node.js-specific APIs).</constraint>
    <constraint>Exactly one decode attempt: avoid double-decoding and handle malformed encodings gracefully.</constraint>
    <constraint>Preserve existing logging/analytics so pre-redirect tracking (NFR5) is unaffected.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>parseDestinationFromQuery</name>
      <kind>Function (new)</kind>
      <signature>function parseDestinationFromQuery(rawUrl: string): { destination: string; debugMode: boolean }</signature>
      <path>src/routes/redirect.ts</path>
    </interface>
    <interface>
      <name>RedirectError</name>
      <kind>Class</kind>
      <signature>class RedirectError extends Error { constructor(message: string, statusCode?: number, code?: string) }</signature>
      <path>src/lib/errors.ts</path>
    </interface>
    <interface>
      <name>redirectSchema</name>
      <kind>Zod Schema</kind>
      <signature>const redirectSchema: z.ZodObject&lt;{ to: string; n?: '0' | '1' }&gt;</signature>
      <path>src/lib/validation.ts</path>
    </interface>
    <interface>
      <name>createRedirectResponse</name>
      <kind>Function</kind>
      <signature>function createRedirectResponse(destination: string, type?: 'permanent' | 'temporary'): Response</signature>
      <path>src/routes/redirect.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Vitest v4 with Miniflare to emulate Workers runtime; keep tests deterministic and validate logging side-effects.</standards>
    <locations>
      <location>test/unit/lib/redirect-logic.test.ts</location>
      <location>test/integration/redirect-endpoint.test.ts</location>
      <location>test/fixtures/env.test.ts</location>
    </locations>
    <ideas>
      <idea ac="1,2,4">Unit test verifying parser accepts raw `to=https://example.com?a=1&b=2` and returns the full destination without double-decoding.</idea>
      <idea ac="2,4">Unit test verifying URL-encoded input is decoded exactly once (e.g., `%2Fpath%3Fq%3D1`).</idea>
      <idea ac="3,4">Integration test ensuring missing `n` results in 400 with `MISSING_PARAM` code and no redirect headers.</idea>
      <idea ac="3,4">Integration test for malformed percent encoding raising `INVALID_ENCODING` and logging warning.</idea>
      <idea ac="5">Documentation regression test (if applicable) to confirm README mentions raw `to` behavior.</idea>
    </ideas>
  </tests>
</story-context>

