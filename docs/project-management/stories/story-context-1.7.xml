<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>7</storyId>
    <title>Test Environment Configuration</title>
    <status>Draft</status>
    <generatedAt>2025-10-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-1.7.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>centralized test environment fixtures and configuration helpers</iWant>
    <soThat>unit and integration tests share consistent Env setups with minimal duplication</soThat>
    <tasks>
      <task id="1" ac="1">Establish shared Env fixtures under test/fixtures/env.ts</task>
      <task id="2" ac="2">Build config-focused helper module that re-exports presets</task>
      <task id="3" ac="3,6">Document test environment defaults in .env.test and README</task>
      <task id="4" ac="4">Align Vitest configuration and setup commentary</task>
      <task id="5" ac="5,7">Refactor existing config tests to consume fixtures and add example spec</task>
      <task id="6" ac="8">Run full Vitest suite to confirm fixture migration is safe</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Create test/fixtures/env.ts exporting shared Env fixtures including defaultTestEnv, createTestEnv(overrides?: Partial&lt;Env&gt;), testEnvWithGA4, testEnvMinimal, and testEnvInvalid collections with JSDoc guidance.</criterion>
    <criterion id="2">Create test/helpers/config.ts wrapping fixtures, exposing createMockEnv() and re-exporting common presets with usage documentation.</criterion>
    <criterion id="3">Add .env.test documenting recommended test environment variables, using non-production GA4 samples and clarifying that the file is informational.</criterion>
    <criterion id="4">Update vitest.config.ts comments and setup to explain fixture usage and ensure setupFiles integrates shared bootstrap.</criterion>
    <criterion id="5">Refactor test/unit/lib/config.test.ts (and related specs) to rely on new helpers, eliminating inline Env mocks while preserving assertions.</criterion>
    <criterion id="6">Update README.md with a "Testing Environment" subsection linking to fixtures and Story 1.6 configuration guidance.</criterion>
    <criterion id="7">Add test/fixtures/env.test.ts demonstrating fixture usage, including GA4-enabled scenarios and override patterns.</criterion>
    <criterion id="8">Run npm test (or equivalent) to confirm the suite passes after fixture migration, addressing any regressions surfaced.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 1.7: Test Environment Configuration</section>
        <snippet>Acceptance Criteria: 1. Create test/fixtures/env.ts with centralized test environment fixtures. 2. Create test/helpers/config.ts with test utilities. 3. Update .env.test with test-specific environment variable defaults. 4. Update vitest.config.ts to define test environment setup.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Testing</section>
        <snippet>Testing: - Vitest v4.0 - Fast unit testing. - Browser Mode for visual regression (future). - Parallel test execution. These decisions drive the fixture strategy to stay compatible with the Workers runtime.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Decision Architecture</title>
        <section>Environment Config</section>
        <snippet>Type-Safe Wrangler Bindings ensure all Env access remains typed. Fixtures must leverage the Env interface so validation logic from Story 1.6 continues to apply during tests.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Jamstack URL Shortener PRD</title>
        <section>2.2 Non-Functional Requirements</section>
        <snippet>**NFR5: Reliability:** The tracking event must be successfully dispatched before the redirect is sent to the client to ensure no data is lost. Consistent test fixtures help validate this reliability contract across scenarios.</snippet>
      </doc>
      <doc>
        <path>README.md</path>
        <title>Project README</title>
        <section>Testing</section>
        <snippet>The testing section documents how to run `npm test` with Vitest and explains configuration of environment variables for local runs, aligning with the new fixture helpers.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/types/env.ts</path>
        <kind>type-definition</kind>
        <symbol>Env</symbol>
        <lines>1-20</lines>
        <reason>Authoritative shape for Workers environment variables; fixtures must comply with this interface to keep tests type-safe.</reason>
      </artifact>
      <artifact>
        <path>test/setup.ts</path>
        <kind>test-bootstrap</kind>
        <symbol>setupTestEnvironment</symbol>
        <lines>1-40</lines>
        <reason>Global Vitest setup executed before suites; fixture utilities must integrate without duplicating bootstrap logic.</reason>
      </artifact>
      <artifact>
        <path>vitest.config.ts</path>
        <kind>config</kind>
        <symbol>defineConfig</symbol>
        <lines>1-18</lines>
        <reason>Centralized Vitest configuration where documentation for new fixtures and setupFiles updates will live.</reason>
      </artifact>
      <artifact>
        <path>test/unit/lib/config.test.ts</path>
        <kind>unit-test</kind>
        <symbol>describe('config module')</symbol>
        <lines>1-120</lines>
        <reason>Existing tests that currently construct Env mocks inline; target for refactoring to use shared fixtures.</reason>
      </artifact>
    </code>
    <dependencies>
      <typescript>5.9.0</typescript>
      <vitest>4.0.3</vitest>
      <miniflare>3.20250718.2</miniflare>
      <wrangler>4.45.3</wrangler>
      <hono>4.4.0</hono>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Fixtures must remain Workers-compatible: avoid Node.js-specific APIs so tests mirror Cloudflare execution.</constraint>
    <constraint>Env presets must not include real secrets; GA4 sample values should match non-production guidance documented in README and .env.example.</constraint>
    <constraint>Shared helpers must preserve Story 1.6 validation rules by using Env typing and RedirectError semantics when constructing invalid configs.</constraint>
    <constraint>Documentation updates must stay consistent with architecture decisions on Vitest + Miniflare to prevent conflicting guidance.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>createTestEnv</name>
      <kind>Function (new)</kind>
      <signature>export function createTestEnv(overrides?: Partial&lt;Env&gt;): Env</signature>
      <path>test/fixtures/env.ts</path>
    </interface>
    <interface>
      <name>createMockEnv</name>
      <kind>Function (new)</kind>
      <signature>export function createMockEnv(overrides?: Partial&lt;Env&gt;): Env</signature>
      <path>test/helpers/config.ts</path>
    </interface>
    <interface>
      <name>defaultTestEnv</name>
      <kind>Constant (new)</kind>
      <signature>export const defaultTestEnv: Partial&lt;Env&gt;</signature>
      <path>test/fixtures/env.ts</path>
    </interface>
    <interface>
      <name>testEnvWithGA4</name>
      <kind>Constant (new)</kind>
      <signature>export const testEnvWithGA4: Env</signature>
      <path>test/fixtures/env.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Adhere to Vitest v4.0 + Miniflare guidance for Cloudflare Workers: colocate unit specs under test/lib, integration under test/integration, and rely on shared setup.ts for global hooks.</standards>
    <locations>
      <location>test/unit/lib/config.test.ts</location>
      <location>test/fixtures/env.test.ts</location>
      <location>test/integration/startup-validation.test.ts</location>
    </locations>
    <ideas>
      <idea ac="1,7">Add fixture-focused unit test verifying createTestEnv merges overrides without mutating defaults.</idea>
      <idea ac="2,5">Refactor config module tests to call createMockEnv and shared GA4 presets, reducing inline duplication.</idea>
      <idea ac="3,6">Write documentation regression test asserting README "Testing Environment" section references fixture paths.</idea>
      <idea ac="4">Ensure vitest.config.ts emits guidance comment about importing fixtures by asserting comment presence.</idea>
      <idea ac="5,8">Execute npm test within CI to confirm all suites pass after fixture migration, capturing failures in analytics scenarios.</idea>
      <idea ac="7">Author example spec in test/fixtures/env.test.ts demonstrating GA4-enabled and minimal presets in action.</idea>
    </ideas>
  </tests>
</story-context>



