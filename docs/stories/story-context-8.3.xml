<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>3</storyId>
    <title>Integrated\ GA4\ in\ Redirect\ Flow</title>
    <status>drafted</status>
    <generatedAt>2025-10-26</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-8.3.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>end user</asA>
    <iWant>my analytics to be tracked before I am redirected</iWant>
    <soThat>no tracking data is lost even if I close the browser quickly</soThat>
    <tasks>      - [ ] Integrate GA4 call in routes/redirect.ts before redirect
      - [ ] Extract TrackingParams; build payload via buildGA4Payload
      - [ ] Await sendGA4Event(payload, GA4 secrets) with 2s timeout; catch/log errors
      - [ ] Ensure non-blocking: redirect proceeds on failure
      - [ ] Tests: GA4 called before redirect; failure still redirects</tasks>
  </story>

  <acceptanceCriteria>
  1. `routes/redirect.ts` updated to extract tracking params from destination URL using `extractTrackingParams()`
  2. Route builds GA4 payload using `buildGA4Payload()` with extracted params
  3. Route calls `await sendGA4Event()` BEFORE returning redirect response
  4. Tracking errors are logged but do NOT prevent redirect from executing
  5. Integration test verifies: tracking function called before redirect response sent
  6. Integration test verifies: redirect still works even if tracking fails/times out
  7. Structured log entry created for tracking attempt (success/failure)
  8. Performance: tracking adds <100ms latency in happy path (within sub-5ms total budget)
</acceptanceCriteria>

  <artifacts>
    <docs>      <doc path="docs/epics.md" title="Epics" section="Story 8.3" snippet="Integrated GA4 in redirect flow"/>
      <doc path="docs/tech-spec-epic-8.md" title="Tech Spec Epic 8" section="Integrated GA4 in Redirect Flow" snippet="Wiring sequence and performance constraints"/>
      <doc path="docs/architecture.md" title="Architecture" section="Analytics Abstraction (Epic 7)" snippet="Router/redirect wiring and non-blocking policy"/>
      <doc path="docs/prd.md" title="PRD" section="FR2/FR3" snippet="Pre-redirect tracking + GA4 integration"/>
      <doc path="docs/sprint-status.yaml" title="Sprint Status" section="development_status" snippet="Tracks 8-3 story status"/></docs>
    <code>      <artifact>
        <path>src/routes/redirect.ts</path>
        <kind>route</kind>
        <symbol>GET /r handler</symbol>
        <lines>1-240</lines>
        <reason>Integrate GA4 call before redirect</reason>
      </artifact>
      <artifact>
        <path>src/lib/tracking.ts</path>
        <kind>library</kind>
        <symbol>sendGA4Event / buildGA4Payload</symbol>
        <lines>1-300</lines>
        <reason>Functions used in redirect flow</reason>
      </artifact></code>
    <dependencies>      <dependency path="wrangler.toml" reason="Env bindings GA4"/>
      <dependency path="package.json" reason="Vitest/Miniflare for tests"/></dependencies>
  </artifacts>

  <constraints>    <constraint type="timeout" description="Apply 2s timeout for GA4 call"/>
    <constraint type="non-blocking" description="Do not block redirect on tracking errors"/>
    <constraint type="performance" description="Add <100ms in happy path; keep sub-5ms core"/></constraints>
  <interfaces>    <interface name="redirectHandler" location="src/routes/redirect.ts" signature="GET /r?to=... (Hono)"/></interfaces>
  <tests>
    <standards>      <standard tool="Vitest v4.0+" purpose="Integration (Miniflare)"/></standards>
    <locations>      <location path="test/integration/routes/redirect.ga4.test.ts" description="GA4 call before redirect; error path"/></locations>
    <ideas>      <test-idea type="integration" description="GA4 called before respond"/>
      <test-idea type="integration" description="GA4 failure still returns redirect"/></ideas>
  </tests>
</story-context>


