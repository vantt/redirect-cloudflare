<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>3</storyId>
    <title>Integrated GA4 in Redirect Flow</title>
    <status>Draft</status>
    <generatedAt>2025-11-01T00:00:00.000Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-8.3.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>redirect service</asA>
    <iWant>integrate the completed GA4 analytics provider into the redirect flow</iWant>
    <soThat>user redirects are tracked reliably without impacting redirect performance</soThat>
    <tasks>- Task 1 (AC: 1, 4, 5, 6) - Redirect Route Integration
  - Subtask 1.1: Import and call trackRedirect() in redirect.ts before redirect response
  - Subtask 1.2: Build RedirectTrackingContext with all required fields
  - Subtask 1.3: Add originalRequestUrl parameter for parameter extraction fallback
  - Subtask 1.4: Wrap tracking call in try-catch with error logging only
- Task 2 (AC: 2, 3) - Provider Registration
  - Subtask 2.1: Create GA4 provider factory function
  - Subtask 2.2: Register factory in analytics registry
  - Subtask 2.3: Add environment variable validation in factory
- Task 3 (AC: 7, 8) - Testing and Validation
  - Subtask 3.1: Create end-to-end integration tests
  - Subtask 3.2: Verify structured logging for tracking integration
  - Subtask 3.3: Performance testing to ensure &lt;5ms redirect budget compliance</tasks>
  </story>

  <acceptanceCriteria>1. Redirect Integration: src/routes/redirect.ts calls trackRedirect(context, env) with complete RedirectTrackingContext before returning redirect response
2. Provider Registration: GA4 provider factory registered in analytics registry with environment variable validation
3. Environment Configuration: ANALYTICS_PROVIDERS environment variable includes 'ga4' for GA4 activation in production
4. Parameter Extraction: RedirectTrackingContext includes originalRequestUrl parameter for original-wins extraction strategy from Story 7.8
5. Error Isolation: Tracking service failures (network errors, timeouts, configuration errors) are caught and logged without blocking redirect responses
6. Performance Compliance: Total redirect processing including tracking adds &lt;5ms latency in happy path, maintains sub-5ms total budget
7. Structured Logging: Integration creates structured log entries for tracking attempts with success/failure status and timing data
8. End-to-End Testing: Integration tests verify complete flow: redirect → tracking → GA4 delivery → redirect response</acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact path="docs/tech-spec-epic-8.md" title="Google Analytics 4 Integration" section="Workflows and Sequencing" snippet="1) Nhận request `/r?to=...` → validate `to`. 2) `extractTrackingParams(to)` → `TrackingParams`. 3) `buildGA4Payload(params, env.GA4_MEASUREMENT_ID)`. 4) `await sendGA4Event(payload, env.GA4_API_SECRET, env.GA4_MEASUREMENT_ID)` với `AbortSignal.timeout(2000)`. 5) Bắt/log lỗi (không throw), trả 301/302."/>
      <artifact path="docs/tech-spec-epic-7.md" title="Analytics Abstraction (Multi-Service)" section="Detailed Design" snippet="routeAnalyticsEvent(event, providers) — fan-out concurrently to multiple providers; per-provider error isolation; apply timeout (AbortSignal.timeout); structured logging for attempt/success/failure/duration"/>
      <artifact path="docs/stories/story-8.1.md" title="GA4 Measurement Protocol Payload Builder" section="Context" snippet="Story 8.1 completed: GA4Provider class implements AnalyticsProvider interface với payload builder; Payload builder creates GA4 Measurement Protocol v2 compliant payloads"/>
      <artifact path="docs/stories/story-8.2.md" title="GA4 Measurement Protocol HTTP Integration" section="Context" snippet="Story 8.2 completed: GA4Provider.send() method thực thi HTTP POST tới GA4 Measurement Protocol endpoint; Timeout 2 giây với proper error isolation theo Epic 7 patterns"/>
      <artifact path="docs/stories/story-7.8.md" title="Tracking Service Abstraction and Redirect Integration" section="Dev Notes" snippet="Design Principles: Single Responsibility: Tracking service owns ALL tracking logic; Clean Interface: redirect.ts only calls trackRedirect(context, env); Provider Agnostic: No GA4/Mixpanel/etc. awareness in tracking service"/>
      <artifact path="docs/architecture.md" title="Architecture Document" section="Performance" snippet="Total (excluding tracking): ~3-4ms ? Within sub-5ms target; Performance must meet sub-5ms requirement"/>
    </docs>
    <code>
      <artifact path="src/routes/redirect.ts" kind="route" symbol="trackRedirect()" lines="37-46" reason="Already integrated with TrackingService.trackRedirect() call with complete RedirectTrackingContext and error isolation"/>
      <artifact path="src/lib/analytics/tracking-service.ts" kind="service" symbol="trackRedirect()" lines="57-77" reason="Core tracking service that extracts parameters, builds AnalyticsEvent, and routes to analytics router"/>
      <artifact path="src/lib/analytics/tracking-service.ts" kind="interface" symbol="RedirectTrackingContext" lines="6-13" reason="Interface defining tracking context with originalRequestUrl parameter for Story 7.8 parameter extraction"/>
      <artifact path="src/lib/analytics/registry.ts" kind="registry" symbol="loadProviders()" lines="28-32" reason="Registry already includes GA4 provider factory; loads providers based on ANALYTICS_PROVIDERS environment variable"/>
      <artifact path="src/lib/analytics/providers/ga4.ts" kind="factory" symbol="createGA4Provider()" lines="19-27" reason="GA4 provider factory function already implemented and registered in analytics registry"/>
      <artifact path="src/types/env.ts" kind="env" symbol="ENABLE_TRACKING" lines="9" reason="Feature flag for global tracking control"/>
      <artifact path="src/types/env.ts" kind="env" symbol="ANALYTICS_PROVIDERS" lines="11" reason="Environment variable controlling which analytics providers are activated"/>
    </code>
    <dependencies>
      <dependency ecosystem="Node.js">
        <package name="hono" version="^4.4.0" purpose="Web framework"/>
        <package name="zod" version="^4.1.0" purpose="Schema validation"/>
        <package name="@hono/zod-validator" version="^0.7.0" purpose="Hono validator middleware"/>
      </dependency>
      <dependency ecosystem="Cloudflare Workers">
        <package name="@cloudflare/workers-types" version="^4.20241004.0" purpose="TypeScript types for Cloudflare Workers"/>
      </dependency>
      <dependency ecosystem="Testing">
        <package name="vitest" version="^4.0.3" purpose="Unit and integration testing framework"/>
        <package name="miniflare" version="^3.20250718.2" purpose="Cloudflare Workers testing environment"/>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="performance" description="Total redirect processing including tracking must add &lt;5ms latency in happy path, maintain sub-5ms total budget per NFR requirements"/>
    <constraint type="error-isolation" description="Tracking service failures must be caught and logged without blocking redirect responses"/>
    <constraint type="environment-configuration" description="ANALYTICS_PROVIDERS environment variable must include 'ga4' for GA4 activation; ENABLE_TRACKING flag controls global tracking"/>
    <constraint type="parameter-extraction" description="RedirectTrackingContext must include originalRequestUrl parameter for original-wins extraction strategy from Story 7.8"/>
    <constraint type="architecture" description="Integration must use existing TrackingService.trackRedirect() and analytics router from Epic 7"/>
    <constraint type="backward-compatibility" description="Integration must not break existing redirect functionality; analytics is additive"/>
  </constraints>
  <interfaces>
    <interface name="trackRedirect()" kind="function" signature="async trackRedirect(context: RedirectTrackingContext, env: Env): Promise&lt;void&gt;" path="src/lib/analytics/tracking-service.ts"/>
    <interface name="RedirectTrackingContext" kind="type interface" signature="interface RedirectTrackingContext { shortUrl: string; destinationUrl: string; redirectType: 'permanent' | 'temporary'; userAgent?: string; ip?: string; originalRequestUrl?: string; }" path="src/lib/analytics/tracking-service.ts"/>
    <interface name="loadProviders()" kind="function" signature="loadProviders(env: Env, providerFactories: ProviderFactories): AnalyticsProvider[]" path="src/lib/analytics/registry.ts"/>
    <interface name="createGA4Provider()" kind="factory function" signature="createGA4Provider(env: Env): GA4Provider" path="src/lib/analytics/providers/ga4.ts"/>
  </interfaces>
  <tests>
    <standards>
      <standard tool="vitest" version="^4.0.3" purpose="Unit and integration testing framework"/>
      <standard tool="miniflare" version="^3.20250718.2" purpose="Cloudflare Workers runtime emulation"/>
      <standard pattern="performance-testing" purpose="Verify sub-5ms redirect budget compliance"/>
      <standard pattern="error-isolation" purpose="Verify tracking failures don't block redirects"/>
      <standard pattern="environment-configuration" purpose="Test ANALYTICS_PROVIDERS and ENABLE_TRACKING flags"/>
    </standards>
    <locations>
      <location path="test/integration/routes/redirect-analytics.test.ts" description="Existing integration test for redirect tracking"/>
      <location path="test/integration/analytics/ga4-end-to-end.test.ts" description="End-to-end GA4 provider integration tests"/>
      <location path="test/performance/redirect-timing.test.ts" description="Performance tests for sub-5ms budget compliance"/>
    </locations>
    <ideas>
      <test type="integration" ac="1" description="Test redirect route calls trackRedirect() with complete RedirectTrackingContext"/>
      <test type="integration" ac="2" description="Test GA4 provider is loaded when ANALYTICS_PROVIDERS includes 'ga4'"/>
      <test type="integration" ac="3" description="Test GA4 provider is not loaded when ANALYTICS_PROVIDERS excludes 'ga4'"/>
      <test type="integration" ac="4" description="Test originalRequestUrl parameter is passed for parameter extraction fallback"/>
      <test type="integration" ac="5" description="Test tracking service failures are caught and logged without blocking redirect"/>
      <test type="integration" ac="6" description="Test redirect processing stays within sub-5ms performance budget"/>
      <test type="integration" ac="7" description="Test structured logging entries are created for tracking attempts"/>
      <test type="integration" ac="8" description="Test end-to-end flow: redirect → tracking → GA4 delivery → redirect response"/>
      <test type="performance" ac="6" description="Measure total redirect processing time with tracking enabled"/>
      <test type="performance" ac="6" description="Verify tracking adds less than 5ms latency in happy path"/>
      <test type="environment" ac="3" description="Test ANALYTICS_PROVIDERS environment variable controls provider activation"/>
      <test type="environment" ac="3" description="Test ENABLE_TRACKING flag controls global tracking functionality"/>
      <test type="edge-case" ac="5" description="Test redirect works when GA4 provider registration fails"/>
      <test type="edge-case" ac="5" description="Test redirect works when GA4 environment variables are missing"/>
      <test type="error-handling" ac="5" description="Test tracking service exceptions are handled gracefully"/>
      <test type="error-handling" ac="5" description="Test analytics router failures don't affect redirect"/>
    </ideas>
  </tests>
</story-context>