<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>1</storyId>
    <title>GA4 Measurement Protocol Payload Builder</title>
    <status>Ready</status>
    <generatedAt>2025-11-01T00:00:00.000Z</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/story-8.1.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>implement a GA4 Measurement Protocol payload builder as part of the GA4 analytics provider</iWant>
    <soThat>analytics events from the TrackingService can be transformed into GA4-compliant payloads for delivery</soThat>
    <tasks>- Task 1 (AC: 1, 6) - Implement GA4 Provider
  - Subtask 1.1: Create src/lib/analytics/ga4/provider.ts
  - Subtask 1.2: Implement GA4Provider class with send() method
  - Subtask 1.3: Register GA4 provider in analytics registry
- Task 2 (AC: 2, 4, 5) - Build Payload Builder
  - Subtask 2.1: Create src/lib/analytics/ga4/payload-builder.ts
  - Subtask 2.2: Implement buildGA4Payload() function
  - Subtask 2.3: Implement parameter mapping logic
  - Subtask 2.4: Implement client ID generation
- Task 3 (AC: 7) - Unit Tests
  - Subtask 3.1: Create test/unit/lib/analytics/ga4/provider.test.ts
  - Subtask 3.2: Create test/unit/lib/analytics/ga4/payload-builder.test.ts
  - Subtask 3.3: Add comprehensive test cases
- Task 4 (AC: 8) - Integration Tests
  - Subtask 4.1: Create test/integration/analytics/ga4-integration.test.ts
  - Subtask 4.2: Test end-to-end flow with TrackingService</tasks>
  </story>

  <acceptanceCriteria>1. GA4 Provider Implementation: Create src/lib/analytics/ga4/provider.ts implementing AnalyticsProvider interface with send(event: AnalyticsEvent): Promise&lt;void&gt; method
2. Payload Builder Function: Implement buildGA4Payload(event: AnalyticsEvent, measurementId: string): GA4Payload that creates Measurement Protocol v2 structure
3. Client ID Generation: Generate GA4-compliant client_id using hash of timestamp + random string (consistent format, not PII)
4. Parameter Mapping: Map AnalyticsEvent attributes to GA4 event parameters:
   - Standard UTM: campaign, source, medium, content, term → campaign_source, campaign_medium, etc.
   - Custom: xptdk, ref → custom_parameters
   - Metadata: short_url, destination_url, redirect_type → event-specific parameters
5. Error Handling: Handle malformed/missing parameters gracefully - omit from payload rather than throwing
6. Integration: Register GA4 provider in analytics registry when 'ga4' is in ANALYTICS_PROVIDERS env
7. Unit Tests: Comprehensive test coverage for payload builder (full params, minimal params, custom params, edge cases)
8. Integration Tests: Verify GA4 provider correctly receives and processes AnalyticsEvent from TrackingService</acceptanceCriteria>

  <artifacts>
    <docs>
      <artifact path="docs/tech-spec-epic-7.md" title="Analytics Abstraction (Multi-Service)" section="Overview" snippet="Mục tiêu của Epic 7 là trừu tượng hóa tầng theo dõi phân tích (analytics) thành một giao diện nhà cung cấp thống nhất, giúp hệ thống gửi sự kiện theo dõi trước khi chuyển hướng mà không phụ thuộc vào một dịch vụ cụ thể."/>
      <artifact path="docs/tech-spec-epic-8.md" title="Google Analytics 4 Integration" section="Overview" snippet="Epic 8 triển khai tích hợp Google Analytics 4 (GA4) theo Measurement Protocol, dựa trên tầng trừu tượng analytics đã xây ở Epic 7. Mục tiêu là gửi sự kiện redirect_click trước khi trả về 301/302, đảm bảo độ tin cậy (NFR5) nhưng không làm chậm luồng người dùng nhờ timeout và cô lập lỗi."/>
      <artifact path="docs/tech-spec-epic-8.md" title="Google Analytics 4 Integration" section="Detailed Design" snippet="src/lib/tracking.ts - Trách nhiệm: buildGA4Payload, sendGA4Event, trackRedirect (cầu nối từ TrackingParams sang GA4)"/>
      <artifact path="docs/stories/story-7.8.md" title="Tracking Service Abstraction and Redirect Integration" section="Dev Notes" snippet="Design Principles: Single Responsibility: Tracking service owns ALL tracking logic; Clean Interface: redirect.ts only calls trackRedirect(context, env); Provider Agnostic: No GA4/Mixpanel/etc. awareness in tracking service"/>
    </docs>
    <code>
      <artifact path="src/lib/analytics/provider.ts" kind="interface" symbol="AnalyticsProvider" lines="16-28" reason="Core interface that GA4 provider must implement with send(event: AnalyticsEvent): Promise&lt;void&gt; method"/>
      <artifact path="src/lib/analytics/types.ts" kind="types" symbol="AnalyticsEvent" lines="20-26" reason="Neutral event model that GA4 provider will receive and transform to GA4 format"/>
      <artifact path="src/lib/analytics/types.ts" kind="types" symbol="AttributeKey" lines="46-66" reason="Standard attribute keys for UTM parameters and custom tracking (xptdk, ref) that must be mapped to GA4 parameters"/>
      <artifact path="src/lib/analytics/registry.ts" kind="registry" symbol="loadProviders" lines="31-64" reason="Function that loads GA4 provider when 'ga4' is in ANALYTICS_PROVIDERS env variable"/>
      <artifact path="src/lib/analytics/tracking-service.ts" kind="service" symbol="trackRedirect" lines="32-50" reason="Service that creates neutral AnalyticsEvent and routes to GA4 provider via analytics router"/>
      <artifact path="src/lib/analytics/providers/ga4.ts" kind="provider" symbol="ExampleGA4Provider" lines="12-25" reason="Example GA4 provider that must be replaced with actual implementation"/>
    </code>
    <dependencies>
      <dependency ecosystem="Node.js">
        <package name="hono" version="^4.4.0" purpose="Web framework"/>
        <package name="zod" version="^4.1.0" purpose="Schema validation"/>
        <package name="@hono/zod-validator" version="^0.7.0" purpose="Hono validator middleware"/>
      </dependency>
      <dependency ecosystem="Testing">
        <package name="vitest" version="^4.0.3" purpose="Unit and integration testing framework"/>
        <package name="miniflare" version="^3.20250718.2" purpose="Cloudflare Workers testing environment"/>
        <package name="@cloudflare/workers-types" version="^4.20241004.0" purpose="TypeScript types for Cloudflare Workers"/>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture" description="GA4 provider must implement AnalyticsProvider interface and follow Epic 7 abstraction patterns"/>
    <constraint type="performance" description="Payload building must add &lt;5ms overhead per Performance NFR"/>
    <constraint type="error-handling" description="GA4 provider errors must be isolated and not block redirect flow (follow provider isolation pattern)"/>
    <constraint type="file-structure" description="GA4 implementation must follow src/lib/analytics/ga4/ directory structure"/>
    <constraint type="parameter-priority" description="Must respect original-wins parameter extraction strategy from Story 7.8"/>
    <constraint type="privacy" description="Client ID generation must not use PII - use timestamp + random hash only"/>
  </constraints>
  <interfaces>
    <interface name="AnalyticsProvider" kind="class interface" signature="interface AnalyticsProvider { readonly name: string; send(event: AnalyticsEvent): Promise&lt;void&gt; }" path="src/lib/analytics/provider.ts"/>
    <interface name="AnalyticsEvent" kind="type interface" signature="interface AnalyticsEvent { name: string; attributes: AnalyticsAttributes }" path="src/lib/analytics/types.ts"/>
    <interface name="loadProviders" kind="function" signature="loadProviders(env: Env, providerFactories: ProviderFactories): AnalyticsProvider[]" path="src/lib/analytics/registry.ts"/>
  </interfaces>
  <tests>
    <standards>
      <standard tool="vitest" version="^4.0.3" purpose="Unit and integration testing framework"/>
      <standard tool="miniflare" version="^3.20250718.2" purpose="Cloudflare Workers runtime emulation"/>
      <standard pattern="mock-providers" purpose="Use mock providers for testing analytics router and registry functionality"/>
      <standard pattern="createTestEnv" purpose="Use centralized test environment fixtures from test/fixtures/env.ts"/>
    </standards>
    <locations>
      <location path="test/unit/lib/analytics/ga4/provider.test.ts" description="Unit tests for GA4 provider implementation"/>
      <location path="test/unit/lib/analytics/ga4/payload-builder.test.ts" description="Unit tests for GA4 payload building logic"/>
      <location path="test/integration/analytics/ga4-integration.test.ts" description="Integration tests for GA4 provider with TrackingService"/>
      <location path="test/utils/mock-providers.ts" description="Mock providers for testing analytics functionality"/>
    </locations>
    <ideas>
      <test type="unit" ac="2" description="Test buildGA4Payload creates Measurement Protocol v2 structure with client_id and events array"/>
      <test type="unit" ac="2" description="Test payload builder handles full parameters (all UTM + custom + metadata)"/>
      <test type="unit" ac="2" description="Test payload builder handles minimal parameters (only required fields)"/>
      <test type="unit" ac="2" description="Test payload builder omits undefined/null parameters from payload"/>
      <test type="unit" ac="3" description="Test client ID generation creates consistent UUID-like format without PII"/>
      <test type="unit" ac="4" description="Test parameter mapping from AnalyticsEvent attributes to GA4 event parameters"/>
      <test type="unit" ac="5" description="Test error handling - malformed events don't throw, just log warning"/>
      <test type="unit" ac="1" description="Test GA4Provider implements AnalyticsProvider interface correctly"/>
      <test type="integration" ac="6" description="Test GA4 provider registration in analytics registry when ANALYTICS_PROVIDERS='ga4'"/>
      <test type="integration" ac="8" description="Test end-to-end flow: TrackingService creates AnalyticsEvent → router routes to GA4 provider → payload built"/>
      <test type="integration" ac="8" description="Test GA4 provider receives correct AnalyticsEvent structure from TrackingService"/>
      <test type="edge-case" ac="2" description="Test payload builder with empty attributes object"/>
      <test type="edge-case" ac="2" description="Test payload builder with special characters in parameter values"/>
      <test type="performance" ac="2" description="Test payload building performance stays under 5ms threshold"/>
    </ideas>
  </tests>
</story-context>