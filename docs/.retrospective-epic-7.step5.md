## Next Epic Preparation Discussion (Step 5) — Epic 8

Facilitator: Bob (Scrum Master)

Objective
- Shift from reflection to readiness. Identify dependencies, setup, knowledge gaps, and risks before starting Epic 8.

Context Inputs
- Tech Spec: docs/tech-spec-epic-8.md (Draft)
- Sprint Status: docs/sprint-status.yaml (Epic 8 = contexted; stories 8-1, 8-2, 8-3)
- Architecture alignment: PRD FR2/FR3; ADR-003 (2s timeout; structured logs; non-blocking)

Dependencies and Continuity
- Epic 8 depends on Epic 7’s analytics abstraction (TrackingParams, provider interface, router, registry, logging).
- GA4 integrates as a provider behind the abstraction without changing redirect flow.

Readiness and Setup (proposed checklist)
Technical Setup
- [ ] Wrangler secrets configured: GA4_API_SECRET; GA4_MEASUREMENT_ID (env)
- [ ] ANALYTICS_PROVIDERS includes `ga4` (or alternative wiring per tech spec)
- [ ] AbortSignal.timeout(2000) available and enforced in GA4 send path
- [ ] Structured logger available with agreed JSON schema

Knowledge and Design
- [ ] Finalize GA4 payload mapping from TrackingParams (campaign/source/medium/content/term + xptdk/ref)
- [ ] Decide client_id generation approach (UUID vs. hash) — consistency and no PII
- [ ] Confirm degrade behavior when ENV missing (warn, skip send)

Testing and Tooling
- [ ] Unit tests for buildGA4Payload (full/minimal/custom)
- [ ] Unit/Integration tests for sendGA4Event (URL, headers, 2s timeout, error handling)
- [ ] Miniflare integration on `/r`: ensure GA4 send occurs before redirect; errors don’t block
- [ ] Observability snapshot tests for log shape (no PII)

Risks and Mitigations
- ENV misconfig (measurement_id/api_secret) -> Validate early; degrade gracefully; structured warnings
- External latency/timeout -> 2s timeout; no throw; log timing; monitor
- Payload schema drift -> Encapsulate in builder; keep tests authoritative

Open Questions for Team
1) Any additional parameters needed for GA4 mapping beyond current TrackingParams?
2) Do we require per-environment differences in provider selection or timeout budget?
3) Any integration constraints with deployment pipeline or secrets management we should account for now?

Preparation Sprint Candidates (initial)
- Secrets and ENV wiring across environments (Owner: Dev, Est: 0.5d)
- Payload builder + unit tests (Owner: Dev, Est: 1d)
- HTTP integration with 2s timeout + tests (Owner: Dev, Est: 1d)
- `/r` wiring + Miniflare integration tests (Owner: Dev, Est: 1d)
- Observability hooks + log snapshot tests (Owner: DevOps, Est: 0.5d)

Notes
- Confirm any constraints from security regarding logging and secret handling before implementation.
